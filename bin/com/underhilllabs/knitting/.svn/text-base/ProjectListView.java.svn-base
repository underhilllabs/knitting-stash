package com.underhilllabs.knitting;

import android.app.ListActivity;
import android.content.Intent;
import android.database.Cursor;
import android.os.Bundle;
import android.util.Log;
import android.view.ContextMenu;
import android.view.Menu;
import android.view.MenuItem;
import android.view.View;
import android.view.ContextMenu.ContextMenuInfo;
import android.widget.AdapterView;
import android.widget.ListView;
import android.widget.SimpleCursorAdapter;
import android.widget.Toast;
import android.widget.AdapterView.AdapterContextMenuInfo;
import android.widget.AdapterView.OnItemClickListener;


public class ProjectListView extends ListActivity {
	
	private DbAdapter pdb;
	private static final int INSERT_ID = Menu.FIRST;
	private static final int VIEW_ID = Menu.FIRST;
    private static final int EDIT_ID = Menu.FIRST + 1;
    private static final int DELETE_ID = Menu.FIRST + 2;
    private static final int HOME_ID = Menu.FIRST + 3;
    private static final int WIP_ID =  Menu.FIRST + 4;
    private static final int ALL_ID =  Menu.FIRST + 5;
    private Cursor cur;
    //private String selectedWord;
	
    @Override
    protected void onCreate(Bundle savedInstanceState){
        super.onCreate(savedInstanceState);
        setContentView(R.layout.project_list_activity_view);
        pdb = new DbAdapter(this);
        pdb.open();
        
        ListView lv = getListView();
        registerForContextMenu(lv);
        
        lv.setOnItemClickListener(new OnItemClickListener() {
			public void onItemClick(AdapterView<?> av, View v, int position,
					long id) {
				Intent i = new Intent(ProjectListView.this, ProjectView.class);
		        i.putExtra("com.underhilllabs.knitting.rowid", id);
		        startActivity(i);
				
			}
         });

        
        fill_data();
        
    }
    @Override
    public void onDestroy() {
    	super.onDestroy();
    	pdb.close();
    }
	public void fill_data() {
    	cur = pdb.fetchAllProjects();        
    	startManagingCursor(cur);
       	String[] displayFields = new String[] { DbAdapter.KEY_NAME, DbAdapter.KEY_NOTES};
       	int[] displayViews = new int[] { R.id.name_row,R.id.notes_row};
       	setListAdapter(new SimpleCursorAdapter(this,R.layout.project_list_row, cur,displayFields, displayViews));
       	//cur.close();
    }
	public void fill_data_wip() {
    	cur = pdb.fetchAllWipProjects();        
       	startManagingCursor(cur);
       	String[] displayFields = new String[] { DbAdapter.KEY_NAME, DbAdapter.KEY_NOTES};
       	int[] displayViews = new int[] { R.id.name_row,R.id.notes_row};
       	setListAdapter(new SimpleCursorAdapter(this,R.layout.project_list_row, cur,displayFields, displayViews));
       	//cur.close();
    }
    @Override
    public boolean onCreateOptionsMenu(Menu menu) {
        boolean result = super.onCreateOptionsMenu(menu);
        MenuItem addm = menu.add(0, INSERT_ID, 0, R.string.menu_add_project);
        addm.setIcon(android.R.drawable.ic_menu_add);
        MenuItem homem = menu.add(0, HOME_ID, 0, "Home");
        homem.setIcon(R.drawable.ic_menu_home);
        MenuItem allm = menu.add(0, ALL_ID, 0, "Show All Projects");
        MenuItem wipm = menu.add(0, WIP_ID, 0, "Show Unfinished Projects");
        
        return result;
    }
    
    @Override
    public boolean onOptionsItemSelected(MenuItem item) {
        switch (item.getItemId()) {
        case INSERT_ID:
            Intent i = new Intent(this, ProjectAddActivity.class);
            startActivity(i);
            return true;
        case ALL_ID:
    		fill_data();
        	return true;
        case WIP_ID:
        	fill_data_wip();
    		return true;
    	case HOME_ID:
    		Intent i3 = new Intent(this, KnittingStashHome.class);
    	    startActivity(i3);
    	    return true;
        }
        
        return super.onOptionsItemSelected(item);
    }
    @Override
    public void onCreateContextMenu(ContextMenu menu, View v,
            ContextMenuInfo menuInfo) {
    	super.onCreateContextMenu(menu, v, menuInfo);
    	
    	menu.add(0, VIEW_ID, 0, "View");
    	menu.add(0, EDIT_ID, 0, "Edit");
    	menu.add(0, DELETE_ID,0,  "Delete");
    	
    	
    	
    }
    @Override
    public boolean onContextItemSelected(MenuItem item) {
    	AdapterContextMenuInfo info = (AdapterContextMenuInfo) item.getMenuInfo();
    	switch (item.getItemId()) {
    	case VIEW_ID:
			Intent i = new Intent(this, ProjectView.class);
	        i.putExtra("com.underhilllabs.knitting.rowid", info.id);
	        startActivity(i);
			return true;
    	case EDIT_ID:
			Intent i2 = new Intent(this, ProjectEditActivity.class);
	        i2.putExtra("com.underhilllabs.knitting.rowid", info.id);
	        startActivity(i2);
			return true;
    	case DELETE_ID:
    			pdb.deleteProject(info.id);
    			fill_data();
    			return true;
    		default:
    			return super.onContextItemSelected(item);
    	}
    }
}
